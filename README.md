# kindle2pdf-v2

Kindle for Mac の表示ページを連続でスクリーンショット撮影し、自動でPDF化するAppleScriptツールです。

## 特徴

✨ **完全自動化**: Kindleウィンドウの検出からPDF生成まで一貫した自動処理
🔍 **重複検出**: 同じページを2回連続で検出したら自動終了
📄 **PDF自動生成**: img2pdfによる高速・高品質なPDF変換
🎯 **簡単操作**: ダイアログに従うだけで完了

## 事前準備

### 必須環境
- **macOS**: 10.15 Catalina 以降
- **Kindle for Mac**: 最新版推奨
- **Python & img2pdf**: PDF生成に使用

### 必要な権限設定

スクリプト実行元（ターミナルまたはScript Editor）に以下の権限を付与してください：

1. **アクセシビリティ権限**（キー入力・ウィンドウ操作用）
   - システム設定 → プライバシーとセキュリティ → アクセシビリティ

2. **スクリーン収録権限**（スクリーンショット撮影用）
   - システム設定 → プライバシーとセキュリティ → 画面収録

⚠️ **重要**: macOS 10.15以降では両方の権限が必須です。

### img2pdfのインストール

```bash
pip install img2pdf
```

## 使い方

### 1. Kindleの準備
- Kindle for Macを起動し、撮影したい本を開く
- **スペースキーでページ送りできる本に対応**（固定レイアウト推奨）
- Kindleウィンドウは1つのみ開いておく（複数開いている場合はエラー）

### 2. スクリプトの実行

```bash
cd /path/to/kindle2pdf-v2
osascript kindle_capture.applescript
```

または、Script Editorで `kindle_capture.applescript` を開いて「再生」ボタンをクリック。

### 3. 実行フロー

1. **Kindleウィンドウを自動検出**
   - 見つからない場合やKindleが複数ある場合はエラーダイアログ表示

2. **ウィンドウを自動的にアクティブ化＋最大化**

3. **開始ページの調整（ユーザー操作）**
   - ダイアログが表示されるので、Kindleで撮影開始ページに移動
   - 準備ができたら「OK」をクリック

4. **撮影ページ数の入力**
   - デフォルト: 10ページ
   - 「キャンセル」で中断可能
   - 1以上の整数のみ入力可能

5. **自動撮影開始**
   - スクリーンショット撮影 → スペースキーでページめくり → 1秒待機
   - この処理を指定ページ数分繰り返し
   - **重複検出機能**: 同じページが2回連続で検出されたら自動終了し、2枚目の重複画像を削除

6. **PDF作成確認**
   - 「PDFファイルを作成しますか？」ダイアログ表示
   - 「PDF作成」: img2pdfですべてのPNG画像を1つのPDFに変換
   - 「スキップ」: PNG画像のみ保存

7. **完了通知**
   - PNG保存先とPDFパス（作成した場合）を表示
   - 「PDFを開く」「フォルダを開く」「OK」から選択

## 出力ファイル

### PNG画像
```
~/Desktop/kindle_screenshots/YYYYMMDD_HHMMSS/
├── page_001.png
├── page_002.png
├── page_003.png
└── ...
```

### PDF（オプション）
```
~/Desktop/kindle_capture_YYYYMMDD_HHMMSS.pdf
```

## 設定のカスタマイズ

スクリプト冒頭の定数で動作を調整できます：

```applescript
property PAGE_TURN_DELAY : 1  -- ページめくり後の待機秒数
```

- **デフォルト**: 1秒
- **低スペック端末や読み込みが遅い場合**: 2-3秒に増やしてください

## トラブルシューティング

### 「Kindleアプリが見つかりません」
- Kindle for Macが起動しているか確認
- 本を開いているか確認

### 「Kindleウィンドウが複数開いています」
- 余分なKindleウィンドウを閉じて1つだけにしてください

### 「PDF作成エラー」
- img2pdfがインストールされているか確認: `which img2pdf`
- パスが正しいか確認: スクリプト内の `img2pdfPath` 変数を環境に合わせて修正

### スクリーンショットが撮影されない
- スクリーン収録権限が付与されているか確認
- システム設定 → プライバシーとセキュリティ → 画面収録

### ページめくりが動作しない
- アクセシビリティ権限が付与されているか確認
- スペースキーでページ送りできる本か確認（固定レイアウト本推奨）

## プロジェクト構成

```
kindle2pdf-v2/
├── kindle_capture.applescript  # メインスクリプト
├── plan.md                     # 設計書（詳細仕様）
├── CLAUDE.md                   # プロジェクトガイドライン
└── README.md                   # 本ファイル
```

## 技術仕様

- **スクリーンショット**: macOS標準の `screencapture` コマンド
- **ページめくり**: System Eventsによるスペースキー送信
- **重複検出**: SHA-256ハッシュによる画像比較
- **PDF変換**: img2pdf（画質劣化なし、高速）

詳細な仕様は [plan.md](plan.md) を参照してください。

## 注意事項

⚠️ **利用規約を遵守してください**
- 本ツールは**私的利用の範囲内**でのみ使用してください
- Kindleの利用規約に従い、著作権法を遵守してください
- 商用利用や再配布は禁止されています

⚠️ **撮影中の注意**
- Kindleウィンドウを操作しないでください
- 他のアプリをKindleの前面に表示しないでください
- Mac がスリープしないように設定してください

## ライセンス

MIT License

## 開発者向け情報

- **設計書**: [plan.md](plan.md) - 詳細な実装仕様と設計思想
- **プロジェクトガイドライン**: [CLAUDE.md](CLAUDE.md) - 開発方針とアーキテクチャ
