# Kindle スクリーンショット自動撮影スクリプト 設計書

## プロジェクト概要

Kindleアプリで開いている書籍のページを自動的に連続でスクリーンショット撮影し、PDF化の準備を行うAppleScriptツール。

## 前提条件と制約事項

### 対応環境
- **OS**: macOS 10.15 Catalina以降
- **Kindle for Mac**: 最新版推奨

### 動作要件
- Kindleアプリが1つのみ起動していること
  - 複数起動している場合はエラーで中断
- 読みたい本が開かれていること
- **スペースキーでページを送れる本に限定**
  - 双方向書籍や特殊レイアウト本の場合は矢印キー等で対応（将来対応予定）

### 必須な権限設定
1. **アクセシビリティ権限**: キー入力とウィンドウ操作用
2. **スクリーン収録権限**: screencaptureコマンド実行用
3. デスクトップフォルダへの書き込み権限

⚠️ **重要**: macOS 10.15以降では両方の権限が必須です。権限なしでは実行できません。

## 機能要件

### 基本機能
- Kindleウィンドウの自動検出とアクティブ化
- ウィンドウの最大化
- 連続スクリーンショット撮影
- 自動ページめくり（スペースキー）

### ユーザー操作
1. スクリプト実行 → Kindleが自動でアクティブ化＋最大化
2. ダイアログで「最初のページに合わせてOK」を待機
3. 撮影ページ数を入力
4. 自動撮影開始

## 設定可能な定数

以下の定数はスクリプト冒頭で定義され、調整可能です。

```applescript
-- ページめくり後の待機秒数（デフォルト: 1秒）
-- 低スペック端末や読み込み遅延がある場合は2-3秒に増加
property PAGE_TURN_DELAY : 1

-- その他の定数（将来拡張用）
-- - ページめくりキー: "space" | "right" | "pagedown"
-- - 画像形式: "png" | "jpg"
```

## 実行フロー詳細

### 1. Kindleウィンドウの自動検出
```applescript
- System Events で全プロセスを走査
- プロセス名に "Kindle" または "Amazon" を含むものを検索
- 見つからない場合:
  * エラーダイアログ: "Kindleアプリが見つかりません。Kindleを起動してください。"
  * スクリプト終了
- 複数のKindleウィンドウが見つかった場合:
  * エラーダイアログ: "Kindleウィンドウが複数開いています。1つだけ開いてください。"
  * スクリプト終了
- 1つのみ見つかった場合: 次のステップへ
```

### 2. Kindleのアクティブ化＋最大化
```applescript
- activate application "Kindle" でアプリを最前面に
- System Events で window bounds を画面サイズに設定
- 最大化完了後、0.5秒待機（描画完了待ち）
```

### 3. ユーザー操作待ち（1回目）
```applescript
- ダイアログ表示: "Kindleの最初のページに合わせてOKを押してください"
- ユーザーがページ位置を手動調整
- OK押下で次へ
```

### 4. 撮影設定入力
```applescript
- ダイアログ表示: "何ページ撮影しますか？"
- デフォルト値: 10
- ユーザーが Cancel を押した場合:
  * スクリプト終了（キャンセル終了処理）
- 空入力の場合:
  * エラーダイアログで通知
  * 再度ダイアログを表示（ループ）
- 数値以外の入力:
  * エラーダイアログで通知
  * 再度ダイアログを表示（ループ）
- 数値検証: 1以上の整数のみ受付
```

### 5. 保存先フォルダ作成
```applescript
- ベースパス取得: POSIX path of (path to desktop folder)
  * iCloud Desktop/別ユーザー設定に自動対応
- サブフォルダ構成: <Desktop>/kindle_screenshots/
- タイムスタンプ付きディレクトリ: YYYYMMDD_HHMMSS/
  * 例: /Users/username/Desktop/kindle_screenshots/20250124_143022/
- フォルダ作成: do shell script "mkdir -p" で作成
- 作成失敗時: エラーダイアログで通知＋スクリプト終了
```

### 6. スクリーンショット撮影ループ
```applescript
repeat with i from 1 to (ページ数)
    # スクリーンショット撮影
    - screencapture でKindleウィンドウをキャプチャ
    - ファイル名: page_001.png, page_002.png, ...（ゼロパディング3桁）
    - 撮影失敗時: エラーメッセージ記録して次へ

    # 最後のページでない場合のみページめくり
    if i < (ページ数) then
        - System Events で keystroke space (スペースキーでページめくり)
        - delay PAGE_TURN_DELAY (デフォルト1秒 - ページ描画待機)
        - ※ 低スペック端末や読み込み遅延がある場合は
          PAGE_TURN_DELAYを2-3秒に増加してください
    end if
end repeat
```

### 7. 完了通知
```applescript
- ダイアログ表示: "N枚のスクリーンショットを保存しました"
- 保存先パス表示
- Finder で保存フォルダを開く（オプション）
```

## 技術的実装ポイント

### AppleScript API
- `System Events`: プロセス検出、ウィンドウ操作、キー入力
- `screencapture`: macOS標準のスクリーンショットコマンド
- `do shell script`: シェルコマンド実行（フォルダ作成、screencapture実行）

### ウィンドウキャプチャ方法
```bash
screencapture -l<windowID> -x <filepath>
```
- `-l<windowID>`: 特定ウィンドウIDのキャプチャ
- `-x`: シャッター音無効化
- windowIDはSystem Eventsから取得

### ページめくり実装
```applescript
tell application "System Events"
    tell process "Kindle"
        keystroke space
    end tell
end tell
```

### ファイル名のゼロパディング
```applescript
set paddedNumber to text -3 thru -1 of ("000" & i)
set fileName to "page_" & paddedNumber & ".png"
```

## ファイル構成

### 出力ファイル
```
~/Desktop/kindle_screenshots/
└── 20250124_143022/
    ├── page_001.png
    ├── page_002.png
    ├── page_003.png
    └── ...
```

### スクリプトファイル
```
/Users/kuniaki-k/Code/kindle2pdf-v2/
├── kindle_capture.applescript  # メインスクリプト（新規作成）
├── tmp.applescript             # ウィンドウ一覧取得（既存・保持）
└── plan.md                     # 本設計書
```

## エラーハンドリング

### Kindle未起動
- エラーダイアログ: "Kindleアプリが見つかりません。Kindleを起動してください。"
- スクリプト終了

### 複数Kindleウィンドウ検出
- エラーダイアログ: "Kindleウィンドウが複数開いています。1つだけ開いてください。"
- スクリプト終了

### 権限エラー
**必須な権限**:
1. **アクセシビリティ権限** (キー入力・ウィンドウ操作)
   - パス: システム環境設定 > セキュリティとプライバシー > アクセシビリティ
   - 手順: スクリプトエディタまたは実行元アプリを追加

2. **スクリーン収録権限** (screencapture実行)
   - パス: システム環境設定 > セキュリティとプライバシー > スクリーン収録
   - 手順: ターミナルまたは実行元アプリを追加

**エラー発生時の対応**:
- エラーダイアログで不足している権限を通知
- システム環境設定へのショートカット案内を表示
- ユーザーが権限を付与した後、スクリプトを再実行

### 数値入力エラー
- 空入力: "ページ数を入力してください。"
- 非数値: "1以上の整数を入力してください。"
- 0以下: "1以上の数値を入力してください。"
- 再度ダイアログを表示（無限ループ）

### 保存先エラー
- フォルダ作成失敗時: "スクリーンショット保存フォルダを作成できませんでした。"
- 原因: ディスク容量、ファイアウォール制限など
- 対応: デスクトップのアクセス権限を確認するよう案内
- スクリプト終了

### キャンセル時の処理
- ユーザーがダイアログで Cancel を選択した場合
- スクリプトを正常に終了（エラーではなく通常終了）

## 今後の拡張可能性

### Phase 2（将来実装）
- PDF自動生成機能
- OCR処理統合
- クラウドアップロード
- バッチ処理（複数の書籍を連続処理）

### カスタマイズオプション
- 撮影間隔の調整
- ページめくり方法の選択（矢印キー/スペース/クリック）
- 画像形式の選択（PNG/JPEG）
- 圧縮率の設定

## 実装スケジュール

1. **Phase 1**: 基本機能実装（本計画）
2. **Phase 2**: エラーハンドリング強化
3. **Phase 3**: PDF変換機能追加
4. **Phase 4**: UI/UX改善

---

**作成日**: 2025-01-24
**最終更新**: 2025-01-24（レビュー反映版）
**バージョン**: 1.1
**ステータス**: 設計完了（レビュー反映）→ 実装待ち
